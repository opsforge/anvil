version: '2'
services:

  ## OPSFORGE CONTAINER
  opsforge:
    restart: always
    image: opsforge/opsforge:latest
    # Replace the values in the following command with your values. Further details in the readme.
    command: /bin/zsh -c "/root/entrypoint.sh MY.NAME myemail@mymailer.com https://pastebin.com/raw/38bgGTK7 https://username:password@bitbucket.org/myproject/myshell-source.git MySecureTerminalPassword"
    ports:
      - 8001:5757
    volumes:
      - ./repos:/root/repos
    network_mode: bridge

  ## CLOUD9 CONTAINERS
  cloud9:
    restart: always
    privileged: true
    command: "-a : "
    image: sapk/cloud9
    volumes:
      - ./repos:/workspace
  pass:
    restart: always
    links:
      - cloud9:web
    environment:
      FORWARD_PORT: 8181
      # Add htpassword here: http://www.htaccesstools.com/htpasswd-generator/ (example below is username=username password=password) - make sure to escape $ signs with $$
      HTPASSWD: 'username:$$apr1$$3X/xufbq$$xBqXarJxuOD0AMXJ4OYin.'
    ports:
      - 8181:80
    image: beevelop/nginx-basic-auth

  ## SHIPYARD CONTAINERS
  rethinkdb:
    restart: always
    hostname: rethinkdb
    image: rethinkdb
    # The volume section is optional and can be commented out if persisting the shipyard configuration is not a concern (the path is also optional)
    volumes:
      - ./shipyard_db:/data
    networks:
      - shipyard
  discovery:
    restart: always
    depends_on:
      - rethinkdb
    hostname: shipyard-discovery
    image: microbox/etcd
    command:  -name discovery
    expose:
      - "4001"
      - "7001"
    networks:
      - shipyard
  proxy:
    restart: always
    depends_on:
      - discovery
    hostname: proxy
    image: opsforge/docker-proxy:latest
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 2375:2375
    environment:
      - PORT=2375
    networks:
      - shipyard
  swarm-manager:
    restart: always
    depends_on:
      - proxy
    expose:
      - "3375"
    image: swarm:latest
    command: manage --host tcp://0.0.0.0:3375 etcd://discovery:4001
    networks:
      shipyard:
        aliases:
          - swarm
          - swarm-manager
  swarm-agent:
    restart: always
    depends_on:
      - swarm-manager
    image: swarm:latest
    command: join --addr proxy:2375 etcd://discovery:4001
    networks:
      shipyard:
        aliases:
          - swarm-agent
  controller:
    restart: always
    depends_on:
      - swarm-agent
    hostname: shipyard-controller
    image: opsforge/shipyard:latest
    command: |
      server
      -d tcp://swarm:3375
    ports:
      - 8080:8080
    networks:
      - shipyard

    # ELK CONTAINERS
    es:
      restart: always
      image: docker.elastic.co/elasticsearch/elasticsearch:6.0.1
      expose:
        - 9200
        - 9300
      volumes:
        - ./es_data:/usr/share/elasticsearch/data
      ulimits:
        memlock:
          soft: -1
          hard: -1
      mem_limit: 1g
      environment:
        - discovery.type=single-node
        - network.host=0.0.0.0
        - discovery.zen.minimum_master_nodes=1
        - "ES_JAVA_OPTS=-Xms512m -Xmx512m"
      networks:
        es:
          aliases:
            - elasticsearch
    ls:
      restart: always
      image: docker.elastic.co/logstash/logstash:6.0.1
      ports:
        - 5000:5000
      # environment:
      #   - LOG_LEVEL=debug
      volumes:
        - ./logstash.conf:/usr/share/logstash/pipeline/logstash.conf
      networks:
        - es
    kib:
      restart: always
      image: docker.elastic.co/kibana/kibana:6.0.1
      ports:
        - 5601:5601
      networks:
        - es

  networks:
    shipyard:
    es:
